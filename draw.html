<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Draw for TiddlyWiki Leaflet plugin</title>

    <link rel="stylesheet" href="./lib/leaflet.css" />
    <link rel="stylesheet" href="./lib/leaflet.pm.css" />

    <script src="./lib/leaflet.js"></script>
    <script src="./lib/leaflet.pm.min.js"></script>
    <script src="./lib/jquery.min.js"></script>
    <script src="./data/fonds.js"></script>

    <style>
body {margin:0;padding:7px;}
.tabs {height:5vh}
#panels, #panels > div, #map {height: calc(95vh - 14px)}

.tabs ul {margin:0 0 1px;padding:0}
.tabs ul li {display:inline-block;border-radius:5px 5px 0 0  ;padding:.25em;border:1px solid; border-bottom: 0}
.tabs ul li {opacity:0.5;background:#eee}
.tabs ul li:hover {opacity:0.75;background:#fff}
.tabs ul li.active {opacity:1;background:#eef}

.pane {display:none}
.pane.active {display:block}

.tiddler, .geom {padding:5px}
.info {width:100%;max-width:800px;margin:auto}

table {border-collapse: collapse}
td {border:.05px solid #ddd}

td, .geom p {font-family:monospace;padding:.25em}
.geom {-moz-column-count:3}
.geom p {padding-left:5em;text-indent:-5em}
    </style>

</head>

<body>
    <div id="tabs" class="tabs">
        <ul>
            <li navto="drawer" class="active" onclick="activate(this);">Map</li>
            <li navto="tiddler" onclick="activate(this);">Export</li>
            <li navto="geom" onclick="activate(this);">Objects</li>
            <li navto="info" onclick="activate(this);">About</li>
        </ul>
    </div>
    <div id="panels" class="panels">
        <div id="drawer" class="drawer pane active">
            <div id="map"></div>
        </div>

        <div id="tiddler" class="tiddler pane">
            The geometries, ready to copy / paste in tiddlers
        </div>

        <div id="geom" class="geom pane">
            All geometries that have been drawn, with their leaflet_id
        </div>

        <div id="info" class="info pane">
            <h1>Draw for TiddlyWiki Leaflet plugin</h1>
            <p>Since the TiddlyWiki <a href="https://sycom.github.io/Leaflet-Plugin/#Leaflet%20Plugin" target="_blank">leaflet plugin</a> doesn't implement a draw mechanism for now, this page uses <a href="http://leafletjs.com" target="_blank">leaflet</a> and leaflet <a href="https://github.com/codeofsumit/leaflet.pm" target="_blank">PM plugin</a> to design shapes for your tiddlywiki leaflet maps.</p>
            <ul>
                <li>Draw or edit shapes on the "<a href="#" navto="drawer" onclick="activate(this);">Map</a>" tab. For now you can make polygons, polylines or points,</li>
                <li>Once finished, go to "<a href="#" navto="tiddler" onclick="activate(this);">Export</a>" tab to get fields values for your geotiddler,</li>
                <li>You may like to see individual coordinates for each object in "<a href="#" navto="geom" onclick="activate(this);">Objects</a>" tab.</li>
            </ul>
        </div>
    </div>


    <script>
    // pane navigation
    function activate(e) {
        $('.tabs ul li').removeClass('active');
        $(e).addClass('active');
        $('#panels .pane').removeClass('active');
        $('#'+e.getAttribute('navto')).addClass('active');
    }


    // some vars
    var lst,                                            // last clicked point
        Obj = [],                                       // objects id
        Pnt = [], Pol = [], Lin = [],                   // categorized objects
        tiddat = document.getElementById("tiddler"),    // place to get tiddler data
        geom = document.getElementById("geom");         // place to get geometries

    // create the map
    var map = L.map('map').setView([49.5, 0.5], 5);
    // create tile layer list for the map
    var Couches = new Array(); // couches de tiles leaflet
    var tiles = {}; // d√©signation des tiles pour le control
    for (i in fonds) {
        var couche = new L.TileLayer(fonds[i].url, {
            attribution: fonds[i].attrib,
            minZoom: fonds[i].zMin,
            maxZoom: fonds[i].zMax,
            unloadInvisibleTiles: true
        });
        Couches[fonds[i].id] = couche;
        tiles[fonds[i].nom] = couche;
    }
    // Install default tile layer in map (first of the list)
    var defaultTile = fonds[0].id;
    Couches[defaultTile].addTo(map);
    // Install tile selector
    var tileSelect = L.control.layers(tiles);
    tileSelect.addTo(map);

    // define toolbar options
    /*var options = {
        position: 'topleft', // toolbar position, options are 'topleft', 'topright', 'bottomleft', 'bottomright'
        drawMarker: true,  // adds button to draw markers
        drawPolygon: true,  // adds button to draw a polygon
        drawPolyline: true,  // adds button to draw a polyline
        editPolygon: true,  // adds button to toggle global edit mode
        deleteLayer: true   // adds a button to delete layers
    };*/

    // add leaflet.pm controls to the map
    map.pm.addControls();

    // create draw layer
    var drawLayer = new L.FeatureGroup();
    drawLayer.addTo(map);
    // optional options
    var options = {
        // makes the layer draggable
        draggable: true,
        // makes the vertices snappable to other layers
        // temporarily disable snapping during drag by pressing ALT
        snappable: true,
        // distance in pixels that needs to be undercut to trigger snapping
        // default: 30
        snapDistance: 15
    };
    drawLayer.pm.enable(options);
    drawLayer.pm.toggleEdit(options);

    // spy clicked points
    /*
    map.on('click', function(e) {
        lst = e.getLatLngs();
        console.log(lst);
    });*/

    // getting drawn shape
    map.on('pm:create', function(e) {
        console.log(e);
        if(e.layer) {
            var eid = e.layer._leaflet_id,
                etype = e.shape,
                coord = "";
            // if the point is a marker
            if(e.layer._latlng) {
                coord = e.layer._latlng.lat+","+e.layer._latlng.lng;
                Pnt.push(eid);
            }

            // if the point is a polygon or a polyline
            if(e.shape == "Line") {
                var Coords = e.layer._latlngs;
                for(var i in Coords) {
                    coord += Coords[i].lat+","+Coords[i].lng+" ";
                }
                coord = coord.slice(0, -1);
                Lin.push(eid);
            }

            // if the point is a polygon or a polyline
            if(e.shape == "Poly") {
                var Coords = e.layer._latlngs[0];
                for(var i in Coords) {
                    coord += Coords[i].lat+","+Coords[i].lng+" ";
                }
                coord = coord.slice(0, -1);
                Pol.push(eid);
            }

            Obj[eid] = {"type": etype, "coord": coord};
            listObjects();
            e.layer.addTo(drawLayer);
        }
    });

    drawLayer.on('pm:edit', function(e) {
        var eLayers = e.target._layers;
        for (var l in eLayers) {
            var ltype = Obj[l].type,
                coord = "";
            // case point
            if(ltype == "Marker") {
                coord = eLayers[l]._latlng.lat+","+eLayers[l]._latlng.lng;
            }
            // case polyline
            if(ltype == "Line") {
                var Coords = eLayers[l]._latlngs;
                for(var i in Coords) {
                    coord += Coords[i].lat+","+Coords[i].lng+" ";
                }
                coord = coord.slice(0, -1);
            }
            // case polygon
            if(ltype == "Poly") {
                var Coords = eLayers[l]._latlngs[0];
                for(var i in Coords) {
                    coord += Coords[i].lat+","+Coords[i].lng+" ";
                }
                coord = coord.slice(0, -1);
            }
            Obj[l].coord = coord;
            listObjects();
        }
        /*if(e.layer) {
            console.log(e.layer);
            var eid = e.layer._leaflet_id,
                etype = e.shape,
                coord = "";
            // if the point is a marker
            if(e.layer._latlng) {
                coord = e.layer._latlng.lat+","+e.layer._latlng.lng;
            }

            // if the point is a polygon or a polyline


            // if the point is a polygon or a polyline
            if(e.shape == "Line") {
                var Coords = e.layer._latlngs;
                for(var i in Coords) {
                    coord += Coords[i].lat+","+Coords[i].lng+" ";
                }
            }

            //console.log(coord);
            Obj[eid] = {"type": etype, "coord": coord};
            listObjects();

        }*/
    });

    function listObjects() {
        var allObj = "", tid = {"point":"","points":"","polygon":"","polygons":"","polyline":"","polylines":""};
        for(var obj in Obj) {
            allObj += "<p>" + Obj[obj].type + "(<i>" + obj + "</i>) : " + Obj[obj].coord + "</p>";
        }
        if(Pnt.length > 1) {
            for(var pnt in Pnt) {
                tid.points += Obj[Pnt[pnt]].coord+" ";
                tid.point = "";
            }
        }
        else {if (Pnt.length == 1) tid.point = Obj[Pnt[0]].coord}
        if(Pol.length > 1) {
            for(var pol in Pol) {
                tid.polygons += Obj[Pol[pol]].coord+"|";
                tid.polygon = "";
            }
            tid.polygons = tid.polygons.slice(0, -1);
        }
        else {if (Pol.length == 1) tid.polygon = Obj[Pol[0]].coord}
        if(Lin.length > 1) {
            for(var lin in Lin) {
                tid.polylines += Obj[Lin[lin]].coord+"|";
                tid.polyline = "";
            }
            tid.polylines = tid.polylines.slice(0, -1);
        }
        else {if (Pol.length == 1) tid.polygon = Obj[Pol[0]].coord}
        geom.innerHTML = allObj;
        var tidText = "<table>";
        for(var feat in tid) {
            tidText += "<tr><td>"+ feat +"</td><td>"+ tid[feat] +"</td></tr>";
        }
        tidText +="</table>";
        tiddat.innerHTML = tidText;
    }

    </script>
</body>

</html>
